C51 COMPILER V9.01   18B20DRIVE                                                            07/20/2013 18:03:38 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE 18B20DRIVE
OBJECT MODULE PLACED IN .\18B20Drive.obj
COMPILER INVOKED BY: D:\(3)keil4\C51\BIN\C51.EXE ..\ModuleDrive\18B20Drive.c BROWSE INCDIR(..\ModuleDrive) DEBUG OBJECTE
                    -XTEND PRINT(.\18B20Drive.lst) OBJECT(.\18B20Drive.obj)

line level    source

   1          /********************************************************************************************************
   2          //程序功能：DS18B20读取温度
   3          /********************************************************************************************************
   4          uint DS18B20_readtemperature()返回的值已经是温度传来的10进制数了。
   5          ********************************************************************************************************/
   6          #include <reg52.h>
   7          #include <intrins.h>                             
   8          #include <18b20Drive.h>
   9          sbit dq=P3^7;
  10          
  11          uchar DS18B20_flag;
  12          
  13          
  14          /********************************************************************************************************
  15          初始化函数
  16          ********************************************************************************************************/
  17          void DS18B20_init()
  18          {
  19   1              dq=1;
  20   1              delay_us(2);                            //拉高一段时间
  21   1              dq=0;
  22   1              delay_us(70);                           //延时480us以上
  23   1              dq=1;
  24   1              while(dq);                                      //等待存在脉冲
  25   1              delay_us(15);                           //存在脉冲存活时间
  26   1              dq=1;                                           //拉高总线
  27   1      }
  28          /********************************************************************************************************
  29          写指令函数，每次写入一个字节dat
  30          ********************************************************************************************************/
  31          void DS18B20_write(uchar dat)
  32          {
  33   1              uchar i;
  34   1              for(i=0;i<8;i++)
  35   1              {
  36   2                      dq=0;
  37   2                      dq=dat&0x01;
  38   2                      delay_us(4);
  39   2                      dq=1;
  40   2                      dat>>=1;
  41   2              }
  42   1      }
  43          /********************************************************************************************************
  44          读函数，每次返回16位的温度值
  45          ********************************************************************************************************/
  46          uint DS18B20_read()
  47          {
  48   1              uchar i;
  49   1              uint dat;
  50   1              for(i=0;i<16;i++)
  51   1              {
  52   2                      dq=0;
  53   2                      dq = 1;
  54   2                      if(dq)
C51 COMPILER V9.01   18B20DRIVE                                                            07/20/2013 18:03:38 PAGE 2   

  55   2                      {
  56   3                              
  57   3                              dat=(dat>>1)|0x8000;
  58   3                      }
  59   2                      else
  60   2                              dat>>=1;//dat = dat >> 1;
  61   2                      dq=1;
  62   2                      delay_us(4);
  63   2              } 
  64   1              return(dat);
  65   1      }
  66          /********************************************************************************************************
  67          读取温度函数，返回温度的绝对值，并标注flag，flag=1表示负，flag=0表示正
  68          ********************************************************************************************************/
  69          uint DS18B20_readtemperature()
  70          {
  71   1              uint DS18B20_temp;
  72   1              float m;
  73   1              DS18B20_init();
  74   1              DS18B20_write(0xcc);                    //跳过读ROM
  75   1              DS18B20_write(0x44);                    //启动温度转换
  76   1              DS18B20_init();
  77   1              DS18B20_write(0xcc);
  78   1              DS18B20_write(0xbe);                    //读取温度寄存器
  79   1              DS18B20_temp=DS18B20_read();
  80   1              if(DS18B20_temp>0x0fff)
  81   1              {
  82   2                      DS18B20_flag=1;
  83   2                      DS18B20_temp=(~DS18B20_temp)+1;
  84   2              }
  85   1              else
  86   1              {
  87   2                      DS18B20_flag=0;
  88   2              }
  89   1              m=DS18B20_temp*0.0625;
  90   1              DS18B20_temp=m*10+0.5;                  //放大10倍四舍五入输出
  91   1              return(DS18B20_temp);
  92   1      }
  93          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    244    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
