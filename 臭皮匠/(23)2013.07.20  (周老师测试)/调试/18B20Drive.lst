C51 COMPILER V9.01   18B20DRIVE                                                            07/20/2013 21:11:01 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE 18B20DRIVE
OBJECT MODULE PLACED IN 18B20Drive.obj
COMPILER INVOKED BY: D:\(3)keil4\C51\BIN\C51.EXE ModuleDrive\18B20Drive.c BROWSE INCDIR(.\IIC_Drive;.\24C02;.\ModuleDriv
                    -e) DEBUG OBJECTEXTEND PRINT(.\18B20Drive.lst) OBJECT(18B20Drive.obj)

line level    source

   1          /********************************************************************************************************
   2          //程序功能：DS18B20读取温度
   3          /********************************************************************************************************
   4          uint DS18B20_readtemperature()返回的值已经是温度传来的10进制数了。
   5          ********************************************************************************************************/
   6          #include <reg52.h>
   7          #include <intrins.h>                             
   8          #include <18b20Drive.h>
   9          sbit dq=P3^7;
  10          
  11          uchar DS18B20_flag;
  12          
  13          void delay_us(uint x)
  14          {
  15   1              while(x--);
  16   1      }
  17          /********************************************************************************************************
  18          初始化函数
  19          ********************************************************************************************************/
  20          void DS18B20_init()
  21          {
  22   1              dq=1;
  23   1              delay_us(2);                            //拉高一段时间
  24   1              dq=0;
  25   1              delay_us(70);                           //延时480us以上
  26   1              dq=1;
  27   1              while(dq);                                      //等待存在脉冲
  28   1              delay_us(15);                           //存在脉冲存活时间
  29   1              dq=1;                                           //拉高总线
  30   1      }
  31          /********************************************************************************************************
  32          写指令函数，每次写入一个字节dat
  33          ********************************************************************************************************/
  34          void DS18B20_write(uchar dat)
  35          {
  36   1              uchar i;
  37   1              for(i=0;i<8;i++)
  38   1              {
  39   2                      dq=0;
  40   2                      dq=dat&0x01;
  41   2                      delay_us(4);
  42   2                      dq=1;
  43   2                      dat>>=1;
  44   2              }
  45   1      }
  46          /********************************************************************************************************
  47          读函数，每次返回16位的温度值
  48          ********************************************************************************************************/
  49          uint DS18B20_read()
  50          {
  51   1              uchar i;
  52   1              uint dat;
  53   1              for(i=0;i<16;i++)
  54   1              {
C51 COMPILER V9.01   18B20DRIVE                                                            07/20/2013 21:11:01 PAGE 2   

  55   2                      dq=0;
  56   2                      dq = 1;
  57   2                      if(dq)
  58   2                      {
  59   3                              
  60   3                              dat=(dat>>1)|0x8000;
  61   3                      }
  62   2                      else
  63   2                              dat>>=1;//dat = dat >> 1;
  64   2                      dq=1;
  65   2                      delay_us(4);
  66   2              } 
  67   1              return(dat);
  68   1      }
  69          /********************************************************************************************************
  70          读取温度函数，返回温度的绝对值，并标注flag，flag=1表示负，flag=0表示正
  71          ********************************************************************************************************/
  72          uint DS18B20_readtemperature()
  73          {
  74   1              uint DS18B20_temp;
  75   1              float m;
  76   1              DS18B20_init();
  77   1              DS18B20_write(0xcc);                    //跳过读ROM
  78   1              DS18B20_write(0x44);                    //启动温度转换
  79   1              DS18B20_init();
  80   1              DS18B20_write(0xcc);
  81   1              DS18B20_write(0xbe);                    //读取温度寄存器
  82   1              DS18B20_temp=DS18B20_read();
  83   1              if(DS18B20_temp>0x0fff)
  84   1              {
  85   2                      DS18B20_flag=1;
  86   2                      DS18B20_temp=(~DS18B20_temp)+1;
  87   2              }
  88   1              else
  89   1              {
  90   2                      DS18B20_flag=0;
  91   2              }
  92   1              m=DS18B20_temp*0.0625;
  93   1              DS18B20_temp=m*10+0.5;                  //放大10倍四舍五入输出
  94   1              return(DS18B20_temp);
  95   1      }
  96          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    234    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
