C51 COMPILER V9.01   DS18B20                                                               07/09/2013 15:00:47 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN DS18B20.OBJ
COMPILER INVOKED BY: D:\(3)keil4\C51\BIN\C51.EXE DS18B20.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /********************************************************************************************************
   2          //程序功能：DS18B20读取温度
   3          ********************************************************************************************************/
   4          #include <reg52.h>
   5          #include <intrins.h>                             
   6          #define uchar unsigned char
   7          #define uint unsigned int
   8          sbit dq=P3^7;
   9          uchar code lab[]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71,0x80};
  10          uchar flag;
  11          uchar disp_buffer[4];
  12          /********************************************************************************************************
  13          延迟函数，x=1大约延迟1ms
  14          ********************************************************************************************************/
  15          void delay(uint x)
  16          {
  17   1              uint i,j;
  18   1              for(i=0;i<x;i++)
  19   1                      for(j=0;j<120;j++);
  20   1      }
  21          /********************************************************************************************************
  22          延迟函数，x=1大约延迟8us
  23          ********************************************************************************************************/
  24          void delay_us(uint x)
  25          {
  26   1              while(x--);
  27   1      }
  28          /********************************************************************************************************
  29          初始化函数
  30          ********************************************************************************************************/
  31          void init()
  32          {
  33   1              dq=1;
  34   1              delay_us(2);                            //拉高一段时间
  35   1              dq=0;
  36   1              delay_us(70);                           //延时480us以上
  37   1              dq=1;
  38   1              while(dq);                                      //等待存在脉冲
  39   1              delay_us(15);                           //存在脉冲存活时间
  40   1              dq=1;                                           //拉高总线
  41   1      }
  42          /********************************************************************************************************
  43          写指令函数，每次写入一个字节dat
  44          ********************************************************************************************************/
  45          void write(uchar dat)
  46          {
  47   1              uchar i;
  48   1              for(i=0;i<8;i++)
  49   1              {
  50   2                      dq=0;
  51   2                      dq=dat&0x01;
  52   2                      delay_us(4);
  53   2                      dq=1;
  54   2                      dat>>=1;
  55   2              }
C51 COMPILER V9.01   DS18B20                                                               07/09/2013 15:00:47 PAGE 2   

  56   1      }
  57          /********************************************************************************************************
  58          读函数，每次返回16位的温度值
  59          ********************************************************************************************************/
  60          uint read()
  61          {
  62   1              uchar i;
  63   1              uint dat;
  64   1              for(i=0;i<16;i++)
  65   1              {
  66   2                      dq=0;
  67   2                      dq = 1;
  68   2                      if(dq)
  69   2                      {
  70   3                              
  71   3                              dat=(dat>>1)|0x8000;
  72   3                      }
  73   2                      else
  74   2                              dat>>=1;//dat = dat >> 1;
  75   2                      dq=1;
  76   2                      delay_us(4);
  77   2              } 
  78   1              return(dat);
  79   1      }
  80          /********************************************************************************************************
  81          读取温度函数，返回温度的绝对值，并标注flag，flag=1表示负，flag=0表示正
  82          ********************************************************************************************************/
  83          uint readtemperature()
  84          {
  85   1              uint temp;
  86   1              float m;
  87   1              init();
  88   1              write(0xcc);                    //跳过读ROM
  89   1              write(0x44);                    //启动温度转换
  90   1              init();
  91   1              write(0xcc);
  92   1              write(0xbe);                    //读取温度寄存器
  93   1              temp=read();
  94   1              if(temp>0x0fff)
  95   1              {
  96   2                      flag=1;
  97   2                      temp=(~temp)+1;
  98   2              }
  99   1              else
 100   1              {
 101   2                      flag=0;
 102   2              }
 103   1              m=temp*0.0625;
 104   1              temp=m*10+0.5;                  //放大10倍四舍五入输出
 105   1              return(temp);
 106   1      }
 107          
 108          /***********************************************************************/
 109          //显示函数
 110          /***********************************************************************/
 111          void display()
 112          {
 113   1              uchar i,temp;
 114   1              temp=0xfe;
 115   1              for(i=0;i<4;i++)
 116   1              {
 117   2                      if(i==1)
C51 COMPILER V9.01   DS18B20                                                               07/09/2013 15:00:47 PAGE 3   

 118   2                      {
 119   3                              P0=lab[disp_buffer[i]]+0x80;
 120   3                      }
 121   2                      else
 122   2                              P0=lab[disp_buffer[i]];
 123   2                      P2=temp;                        
 124   2                      delay(2);
 125   2                      P2=0xff;
 126   2                      temp=(temp<<1)|0x01;            
 127   2              }       
 128   1      }
 129          /********************************************************************************************************
 130          主函数  把温度显示在数码管上
 131          ********************************************************************************************************/
 132          void main()
 133          {
 134   1              uint temp,i;
 135   1              while(1)
 136   1              {       
 137   2                      temp=readtemperature();
 138   2                      disp_buffer[2]=temp%10;
 139   2                      disp_buffer[1]=temp%100/10;
 140   2                      disp_buffer[0]=temp/100;
 141   2                      for(i=0;i<50;i++)
 142   2                      {
 143   3                              display();
 144   3                      }
 145   2                                      
 146   2              }
 147   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    406    ----
   CONSTANT SIZE    =     17    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      5       7
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
